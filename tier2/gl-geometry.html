<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../tier1/gl-vertexbuffer.html">

<polymer-element name="gl-geometry" constructor="glGeometry">
<template>
	<gl-vertexbuffer id="v"></gl-vertexbuffer>
	<gl-vertexbuffer id="vt"></gl-vertexbuffer>
	<gl-vertexbuffer id="vn"></gl-vertexbuffer>
</template>
<script>Polymer((function static(){
	const GL = WebGLRenderingContext.prototype;
	const PROTOTYPE={
		publish:{
			src:""
		},
		fromOBJ:function(source){
			const MESH = this;
			const REFS = [];
			const ENUM = {
				v:0,
				vt:1,
				vn:2
			};
			const BUFFERS = [
				this.$.v,
				this.$.vt,
				this.$.vn
			];
			source.split("\n").forEach(function(line){
				const STATEMENT = line.split(/\s+/);
				const NAME = STATEMENT.shift().toLowerCase();

				if(NAME === "v" || NAME === "vt" || NAME === "vn"){
					const INDEX = ENUM[NAME];

					if(!REFS[INDEX]) REFS[INDEX] = [];
					BUFFERS[INDEX].size = STATEMENT.length;
					REFS[INDEX].push(STATEMENT.map(function(value){
						return Number(value);
					}));
				}
				if(NAME === "f"){
					STATEMENT.forEach(function(face,faceIndex){
						face.split("/").forEach(function(pointer,index){
							pointer = Number(pointer)-1;
							const TARGET = BUFFERS[index];
							const SOURCE = REFS[index][pointer];
							if(!(TARGET.data instanceof Array)) TARGET.data = [];
							[].push.apply(TARGET.data,SOURCE);
						});
					});
				}
			});
			this.$.v.convertToTypedArray();
			this.$.vt.convertToTypedArray();
			this.$.vn.convertToTypedArray();
			this.$.v.fire("load");
			this.$.vt.fire("load");
			this.$.vn.fire("load");
		},
		srcChanged:function(o,n){
			const isOBJ = /\.obj$/i.test(n);
			const xhr = new XMLHttpRequest;
			const MESH = this;
			
			this.$.v.data = [];
			this.$.vt.data = [];
			this.$.vn.data = [];
			
			xhr.open("GET",n);
			xhr.onreadystatechange = function(){
				if(xhr.readyState === xhr.DONE && xhr.status === 200){
					if(isOBJ){
						MESH.fromOBJ(xhr.response);
					}
				}
			}
			xhr.send();
		}
	};
	return PROTOTYPE;
})());
/*
*/</script>
</polymer-element>
