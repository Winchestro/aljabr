<link rel="import" href="GLElement.html">

<link rel="import" href="GLShader.html">

<script>(function STATIC(){
	"use strict";
	const GL 			= WebGLRenderingContext.prototype;
	const NS 			= Symbol.for("GLElements");
	const GLOBAL 		= window[NS];
	const PROTOTYPE 	= GLOBAL.Interface.GLElement;
	const GLShader 		= GLOBAL.Class.GLShader;

	const METHODS = {
		codeChanged:function(o,n){
			this.shader.code = this.code;
			if(n && this.shader.gl) this.recompileShader();
		},
		typeChanged:function(o,n){
			this.shader.type = this.type;
			if(n && this.shader.gl) this.recompileShader();	
		},
		sharedChanged:function(o,n){
			this.shader.shared = this.shared;
			this.dispatch("shader-scope-changed",{
				shader:this.shader,
				shared:this.shared
			});
		},
		srcChanged:function(o,n){
			const $ = this;
			
			if (n) {
				this.dispatch("shader-loading-started",{
					shader:this.shader
				});
				this.shader.loadAsync(n).then(function(shader){
					$.recompileShader();
				},function(error){
					$.dispatch("shader-loading-error",{
						shader:$.shader,
						error:error
					});
				});
			} else {
				if(this.shader.imported){
					this.shader.imported = "";
					this.recompileShader();
				} else if (!this.shader.COMPILE_STATUS) {
					this.recompileShader();
				}
			}
		},
		includesChanged:function(o,n){
			if(n && this.shader.gl) {
				this.shader.includeQuery(n);
				this.recompileShader();
			}
		},
		checkintervalChanged:function(o,n){
			this.shader.dirtyCheck(this.checkinterval);
		},
		recompileShader:function(){
			this.shader.recompile()
			if(this.shader.COMPILE_STATUS){
				this.dispatch("shader-compile-success",{
					shader:this.shader
				});
			}else{
				console.error(this.shader.InfoLog);
				this.dispatch("shader-compile-error",{
					shader:this.shader,
					error:this.shader.InfoLog
				});
			}
		},
	};
	const ENUM = {
		$TYPE_VERTEX:GL.VERTEX_SHADER,
		$TYPE_FRAGMENT:GL.FRAGMENT_SHADER
	};
	const ATTRIBUTES = {
		type:GL.FRAGMENT_SHADER,
		code:"",
		src:"",
		includes:"",
		checkinterval:0,
		shared:false
	};
	const LIFECYCLE = {
		created:function(){
			if(this.parentElement.createShader){
				this.shader = this.parentElement.createShader(
					this.type,
					this.code,
					this.shared,
					this.id
				).includeQuery(this.includes);
				this.srcChanged(null,this.src);
			}
			/*
			this.shader = new glShader(this.type,this.code,this.id)
			.setup(this.parentElement.program)
			.includeQuery(this.includes);
			this.srcChanged(this.src);
			*/
		}
	};


	new GLOBAL.Element(PROTOTYPE,"gl-shader")
		.copy(METHODS,"methods")
		.copy(ATTRIBUTES,"attributes")
		.copy(LIFECYCLE,"lifecycle")
		.copy(ENUM,"enum")
	;
})();/* 


	PROTOTYPE.describeElement(PROTOTYPE,"gl-shader",
		{
			methods:METHODS,
			attributes:ATTRIBUTES,
			lifecycle:LIFECYCLE,
			enum:ENUM,
			factories:FACTORIES
		}
	);
*/</script>