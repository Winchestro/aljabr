<script>(function(){
	"use strict";
	const GL 			= WebGLRenderingContext.prototype;
	const NS 			= Symbol.for("GLElements");
	const GLOBAL 		= window[NS];
	function GLResource(source){
		this.source = source;
		this.pipeline = [];
		this.currentStage = 0;
	}

	const PROTOTYPE = {
		process:function(data){
			
		},
		pipe:function(fn){

		},
		ObjToArrays:function(srcstring){
			const RESULT = {};
			srcstring.split("\n").forEach(function(row){
				row = row.split(" ");
				const TYPE = row.shift().toLowerCase();

				if(!RESULT[TYPE]) RESULT[TYPE] = [];
				const TARGET = RESULT[TYPE];
				switch(TYPE){
					case "v":
					case "vt":
					case "vn":
						var VERTEX = row.map(function(e){
							return parseFloat(e);
						});
						TARGET.push(VERTEX);
						break;
					case "f":
						var INDEX = row.map(function(e){
							return parseInt(e.split("/")[0],10);
						});
						TARGET.push(INDEX);
						break;
					default:
						break;
				}
			})
			return RESULT;
		},
		ObjToIndexedArrays:function(srcstring){
			const REFS = {v:[],vt:[],vn:[]};
			const RESULT = {v:[],vt:[],vn:[]};
			const ORDER = ["v","vt","vn"];
			srcstring.split("\n").forEach(function(row){
				row = row.split(" ");
				const TYPE = row.shift().toLowerCase();
				switch(TYPE){
					case "v":
					case "vt":
					case "vn":
						var VERTEX = row.map(function(e){
							return parseFloat(e);
						});
						REFS[TYPE].push(VERTEX);
						break;
					case "f":
						var INDEX = row.forEach(function(face){
							face.split("/").forEach(function(index,i){
								index = parseInt(index)-1;
								var type = ORDER[i];
								RESULT[type].push(REFS[type][index]);
							});
						});
						break;
					default:
						break;
				}
			});
			return RESULT;
		}
	};

	const STATIC = {
		css:function(target,selector){
			const col = [];
			const PRIMITIVE = CSSPrimitiveValue;
			const TARGET = document.querySelector(selector);

			//this.createShadowRoot();
			//this.shadowRoot.innerHTML = "<style>:host{display:block;visibility:hidden;transition:1ms;}</style>";
			/*
			var rgb = v.getRGBColorValue();
			var p = rgb.red.primitiveValue;

			col[0] = rgb.red.getFloatValue(PRIMITIVE.CSS_NUMBER);
			col[1] = rgb.green.getFloatValue(PRIMITIVE.CSS_NUMBER);
			col[2] = rgb.blue.getFloatValue(PRIMITIVE.CSS_NUMBER);
			console.log(col);
			*/
			TARGET.handleEvent=function(e){
				var c = getComputedStyle(this);
				var v = c.getPropertyCSSValue(property);
				
			};
			this.addEventListener("transitionend",TARGET);
			this.style.color = "#555";
		},
		url:function(url,responseType,interval){
			
			const x = new XMLHttpRequest;
			const r = new GLResource({
				url:url,
				request:x,
				interval:interval||0,
				responseType:responseType||"",
				lastUpdated:0,
				resend:function(){	
					x.open("GET",r.source.url);
					x.responseType = r.source.responseType;
					x.send();
				}
			});
			x.onreadystatechange = resolve;
			r.source.resend();
			return r;
			
			function resolve(){
				//console.log(x.readyState);
				switch(x.readyState){
					case x.UNSENT:
						break;
					case x.OPENED:
						
						break;
					case x.HEADERS_RECEIVED:
						r.source.lastModified = new Date(
							x.getResponseHeader("Last-Modified")
						).getTime();

						//console.log(x,r.source.lastModified-r.source.lastUpdated);
						if(r.source.lastModified>r.source.lastUpdated){
							r.source.lastUpdated = Date.now();
						}else{
							x.abort();
							console.log("no change")
							if(r.source.interval) setTimeout(r.source.resend,r.source.interval);
						}
						break;
					case x.LOADING:
						break;
					case x.DONE:
						switch(x.status){
							case 200:
								r.process(x.response);
								console.log("data changed")
								if(r.source.interval) setTimeout(r.source.resend,r.source.interval);
								break;
							default:
								console.error(x.status+" "+x.statusText);
								if(r.source.interval) setTimeout(r.source.resend,r.source.interval);
								break;
						}
					break;
				}
			}
		},
	};

	new GLOBAL.Class(PROTOTYPE,GLResource)
		.static(STATIC)
	;
})();
/* 
	
*/</script>
