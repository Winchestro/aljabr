<link rel="import" href="GLRendertarget.html">

<script>(function STATIC(){
	"use strict";
	const GL 			= WebGLRenderingContext.prototype;
	const NS 			= Symbol.for("GLElements");
	const GLOBAL 		= window[NS];
	const GLProgram 	= GLOBAL.Class.GLProgram;

	const BINDINGS = [
		"lineWidth",
		"pixelStorei",
		"polygonOffset",
		"sampleCoverage",
		"enable",
		"disable",
		"depthFunc",
		"depthMask",
		"depthRange",
		"stencilFunc",
		"stencilFuncSeparate",
		"stencilMask",
		"stencilMaskSeparate",
		"stencilOp",
		"stencilOpSeparate",
		"blendFunc",
		"blendFuncSeparate",
		"blendEquation",
		"blendEquationSeparate",
		"blendColor",
		"scissor",
		"frontFace",
		"colorMask",
		"cullFace",
		"hint",
		"getExtension"
	];
	const STATES = [
		"ACTIVE_TEXTURE",
		"ALIASED_LINE_WIDTH_RANGE",
		"ALIASED_POINT_SIZE_RANGE",
		"ALPHA_BITS",
		"ARRAY_BUFFER_BINDING",
		"BLEND",
		"BLEND_COLOR",
		"BLEND_DST_ALPHA",
		"BLEND_DST_RGB",
		"BLEND_EQUATION_ALPHA",
		"BLEND_EQUATION_RGB",
		"BLEND_SRC_ALPHA",
		"BLEND_SRC_RGB",
		"BLUE_BITS",
		"COLOR_CLEAR_VALUE",
		"COLOR_WRITEMASK",
		"COMPRESSED_TEXTURE_FORMATS",
		"CULL_FACE",
		"CULL_FACE_MODE",
		"CURRENT_PROGRAM",
		"DEPTH_BITS",
		"DEPTH_CLEAR_VALUE",
		"DEPTH_FUNC",
		"DEPTH_RANGE",
		"DEPTH_TEST",
		"DEPTH_WRITEMASK",
		"DITHER",
		"ELEMENT_ARRAY_BUFFER_BINDING",
		"FRAMEBUFFER_BINDING",
		"FRONT_FACE",
		"GENERATE_MIPMAP_HINT",
		"GREEN_BITS",
		"IMPLEMENTATION_COLOR_READ_FORMAT",
		"IMPLEMENTATION_COLOR_READ_TYPE",
		"LINE_WIDTH",
		"MAX_COMBINED_TEXTURE_IMAGE_UNITS",
		"MAX_CUBE_MAP_TEXTURE_SIZE",
		"MAX_FRAGMENT_UNIFORM_VECTORS",
		"MAX_RENDERBUFFER_SIZE",
		"MAX_TEXTURE_IMAGE_UNITS",
		"MAX_TEXTURE_SIZE",
		"MAX_VARYING_VECTORS",
		"MAX_VERTEX_ATTRIBS",
		"MAX_VERTEX_TEXTURE_IMAGE_UNITS",
		"MAX_VERTEX_UNIFORM_VECTORS",
		"MAX_VIEWPORT_DIMS",
		"PACK_ALIGNMENT",
		"POLYGON_OFFSET_FACTOR",
		"POLYGON_OFFSET_FILL",
		"POLYGON_OFFSET_UNITS",
		"RED_BITS",
		"RENDERBUFFER_BINDING",
		"RENDERER",
		"SAMPLE_BUFFERS",
		"SAMPLE_COVERAGE_INVERT",
		"SAMPLE_COVERAGE_VALUE",
		"SAMPLES",
		"SCISSOR_BOX",
		"SCISSOR_TEST",
		"SHADING_LANGUAGE_VERSION",
		"STENCIL_BACK_FAIL",
		"STENCIL_BACK_FUNC",
		"STENCIL_BACK_PASS_DEPTH_FAIL",
		"STENCIL_BACK_PASS_DEPTH_PASS",
		"STENCIL_BACK_REF",
		"STENCIL_BACK_VALUE_MASK",
		"STENCIL_BACK_WRITEMASK",
		"STENCIL_BITS",
		"STENCIL_CLEAR_VALUE",
		"STENCIL_FAIL",
		"STENCIL_FUNC",
		"STENCIL_PASS_DEPTH_FAIL",
		"STENCIL_PASS_DEPTH_PASS",
		"STENCIL_REF",
		"STENCIL_TEST",
		"STENCIL_VALUE_MASK",
		"STENCIL_WRITEMASK",
		"SUBPIXEL_BITS",
		"TEXTURE_BINDING_2D",
		"TEXTURE_BINDING_CUBE_MAP",
		"UNPACK_ALIGNMENT",
		"UNPACK_COLORSPACE_CONVERSION_WEBGL",
		"UNPACK_FLIP_Y_WEBGL",
		"UNPACK_PREMULTIPLY_ALPHA_WEBGL",
		"VENDOR",
		"VERSION",
		"VIEWPORT"
	];
	const FACTORIES = {
		createProgram:function(uuid){
			return new GLProgram(this,uuid);
		}
	};
	function GLContext(canvas,quality,options){
		this.canvas = canvas;
		this.programs = Object.create(this.programs);
		this.updateQuality(quality).updateContext(options).startDrawLoop();
	}
	const PROTOTYPE = {
		programs:{},
		updateContext:function(options){
			this.options = options || {};
			window.gl = this.gl = this.canvas.getContext("webgl",this.options) || 
			this.canvas.getContext("experimental-webgl",this.options);
			return this;
		},
		updateQuality:function(v){
			isNaN(v) ? v = 2 : v = v || 2;
			this.quality = v;
			this.canvas.width = this.canvas.clientWidth / v;
			this.canvas.height = this.canvas.clientHeight / v;
			
			return this;
		},
		viewport:function(x,y,width,height){
			this.gl.viewport(x,y,width,height);
			return this;
		},
		startDrawLoop:function(){
			const $ = this;
			this.drawing = true;
			draw();
			function draw(){
				if($.drawing) requestAnimationFrame(draw);
				const current = $.CURRENT_PROGRAM;
				for(var p in $.programs){
					$.programs[p].draw(current);
				}
			}
			return this;
		}
	}

	for (var b in BINDINGS) PROTOTYPE[BINDINGS[b]] = new Function(
		"this.gl."+BINDINGS[b]+".apply(this.gl,[].slice.call(arguments));\nreturn this;"
	);
	for (var s in STATES) Object.defineProperty(PROTOTYPE,STATES[s],{
		get: new Function(
			"return this.gl.getParameter("+GL[STATES[s]]+")"
		)
	});

	new GLOBAL.Class(PROTOTYPE,GLContext)
		.copy(FACTORIES)
	;
})();
/* 
	
*/</script>
